!function(a,b,c){"use strict";function d(a){var d;a===c&&(a=b),this.rawCrystalForms=[].slice.call(a.getElementsByTagName("form")),this.crystallized=[],d=function(){for(var a=0;a<this.rawCrystalForms.length;a++)this.rawCrystalForms[a].dataset.crystalId=a+1,this.crystallized.push(new e(this.rawCrystalForms[a]))}.bind(this)()}function e(a){var b;this.rawFields=[].slice.call(a.querySelectorAll("input, textarea")),this.crystallizedFields={},b=function(){for(var b=0;b<this.rawFields.length;b++)if(this.rawFields[b].dataset.crystal!=c){var d=this.rawFields[b].dataset.crystal;this.crystallizedFields[d]=new f(this.rawFields[b])}else this.rawFields.splice(b,1);this.watch(a)}.bind(this)()}function f(a,b){var c;this.defaults={attribute:a.dataset.crystal,domOBJ:a,regex:/[\s\S]*/,lastState:!1,timesActive:0,trigger:"input"},this.config=f.augment({},this.defaults,b||{}),this.isValid={handleEvent:function(){return this.config.regex.test(this.config.domOBJ.value)?(this.config.domOBJ.className=this.config.domOBJ.className.replace(/(?:^|\s)crystal-invalid(?!\S)/g,""),this.config.lastState=!0,!0):(this.config.domOBJ.className+=" crystal-invalid",this.config.lastState=!1,!1)}.bind(this)},c=function(){"input"!==this.config.trigger&&"blur"!==this.config.trigger&&(this.config.trigger=this.defaults.trigger),this.config.domOBJ.addEventListener(this.config.trigger,this.isValid,!1)}.bind(this)()}function g(a){return h(arguments,function(b){b!==a&&h(b,function(b,c){a[c]=b})}),a}function h(a,b,c){var d;if(a)if("undefined"!=typeof a.length){for(d=0;d<a.length;d++)if(b.call(c,a[d],d)===!1)return}else for(d in a)if(a.hasOwnProperty(d)&&b.call(c,a[d],d)===!1)return}function j(){this._listeners={}}d.prototype={ee:new j,popCrystalForm:function(){var a=this.crystallized.length-1;this.crystallized[a].selfDestruct(),this.rawCrystalForms.pop(),this.crystallized.pop()},removeCrystalForm:function(a){this.crystallized[a-1].selfDestruct(),this.rawCrystalForms.splice(a-1,1),this.crystallized.splice(a-1,1);for(var b=0;b<this.rawCrystalForms.length;b++)this.rawCrystalForms[b].dataset.crystal=b+1},addCrystalForm:function(a){this.rawCrystalForms.push(a),this.crystallized.push(new e(a))},getCrystalForm:function(a){return this.crystallized[a-1]},removeCrystalField:function(a,b){this.getCrystalForm(a).removeField(b)},addCrystalField:function(a,b){this.getCrystalForm(a).addField(b)},getCrystalField:function(a,b){return this.getCrystalForm(a).crystallizedFields[b]},setCrystalFieldConfig:function(a,b,c){if("number"==typeof a)this.getCrystalField(a,b).config=f.augment({},this.getCrystalField(a,b).defaults,c||{});else if("all"==a)for(var d=0;d<this.crystallized.length;d++)this.crystallized[d].crystallizedFields[b].config=f.augment({},this.crystallized[d].crystallizedFields[b].defaults,c||{});else for(var d=0;d<a.length;d++)this.getCrystalField(a[d],b).config=f.augment({},this.getCrystalField(a[d],b).defaults,c||{})},selfDestruct:function(){for(var a=0;a<this.crystallized.length;i++)this.removeCrystalForm(a)}},e.prototype={ee:d.prototype.ee,watch:function(a){a.addEventListener("submit",function(b){var c=!0;for(var d in this.crystallizedFields)0==this.crystallizedFields[d].config.lastState&&(c=!1);c?this.ee.emit("form-"+a.dataset.crystalId+"-valid",a):(b.preventDefault(),this.ee.emit("form-"+a.dataset.crystalId+"-invalid",a))}.bind(this),!1)},removeField:function(a){this.crystallizedFields[a].selfDestruct();for(var b=0;b<this.rawFields.length;b++)this.crystallizedFields[a].domOBJ===this.rawFields[b]&&this.rawFields.splice(b,1);delete this.crystallizedFields[a]},addField:function(a){var b;return a.dataset.crystal==c?(console.log('Field element\'s "data-crystal" property must be defined.'),void 0):(b=fieldEl.dataset.crystal,this.rawFields.push(a),this.crystallizedFields[b]=new f(a),void 0)},selfDestruct:function(){for(var a in this.crystallizedFields)this.crystallizedFields[a].selfDestruct()}},f.prototype={wasActive:function(){return this.config.domOBJ==b.activeElement?(this.config.timesActive++,this.config.timesActive):this.config.timesActive},selfDestruct:function(){this.config.domOBJ.removeEventListener(this.config.trigger,this.isValid,!1)}},f.augment=g,j.prototype.on=function(a,b){return Array.isArray(this._listeners[a])||(this._listeners[a]=[]),-1===this._listeners[a].indexOf(b)&&this._listeners[a].push(b),this},j.prototype.once=function(a,b){function d(){for(var e=[],f=0;f<arguments.length;f+=1)e[f]=arguments[f];c.off(a,d),b.apply(c,e)}var c=this;return d.listener=b,this.on(a,d)},j.prototype.off=function(a,b){if(!Array.isArray(this._listeners[a]))return this;if("undefined"==typeof b)return this._listeners[a]=[],this;var c=this._listeners[a].indexOf(b);if(-1===c)for(var d=0;d<this._listeners[a].length;d+=1)if(this._listeners[a][d].listener===b){c=d;break}return this._listeners[a].splice(c,1),this},j.prototype.emit=function(a){if(!Array.isArray(this._listeners[a]))return this;for(var b=[],c=1;c<arguments.length;c+=1)b[c-1]=arguments[c];return this._listeners[a].forEach(function(a){a.apply(this,b)},this),this},"object"==typeof module&&module&&"object"==typeof module.exports?module.exports=d:(a.Crystal=d,"function"==typeof define&&define.amd&&define("crystal",[],function(){return d}))}(window,document);