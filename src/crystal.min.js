!function(a,b,c){"use strict";function d(a){var d;a===c&&(a=b),this.rawForms=[].slice.call(a.getElementsByTagName("form")),this.crystallized=[],d=function(){for(var a=0;a<this.rawForms.length;a++)this.rawForms[a].dataset.crystalId=a+1,this.crystallized.push(new e(this.rawForms[a],this.ee))}.bind(this)()}function e(a,b){var d;this.rawFields=[].slice.call(a.querySelectorAll("input, textarea")),this.crystallizedFields={},d=function(){for(var d=0;d<this.rawFields.length;d++)if(this.rawFields[d].dataset.crystal!=c){var e=this.rawFields[d].dataset.crystal;this.crystallizedFields[e]=new f(this.rawFields[d])}else this.rawFields.splice(d,1);this.watch(a,b)}.bind(this)()}function f(a,b){var c;this.defaults={attribute:a.dataset.crystal,domOBJ:a,regex:/[\s\S]*/,lastState:!1,timesActive:0,trigger:"input"},this.config=f.augment({},this.defaults,b||{}),c=function(){"input"!==this.config.trigger&&"blur"!==this.config.trigger&&(this.config.trigger=this.defaults.trigger),this.config.domOBJ.addEventListener(this.config.trigger,function(){this.isValid()}.bind(this))}.bind(this)()}function g(a){return h(arguments,function(b){b!==a&&h(b,function(b,c){a[c]=b})}),a}function h(a,b,c){var d;if(a)if("undefined"!=typeof a.length){for(d=0;d<a.length;d++)if(b.call(c,a[d],d)===!1)return}else for(d in a)if(a.hasOwnProperty(d)&&b.call(c,a[d],d)===!1)return}function i(){this._listeners={}}d.prototype={ee:new i,popForm:function(){this.rawForms.pop(),this.crystallized.pop()},removeForm:function(a){this.rawForms.splice(a-1,1),this.crystallized.splice(a-1,1);for(var b=0;b<this.rawForms.length;b++)this.rawForms[b].dataset.crystal=b+1},addForm:function(a){this.rawForms.push(a),this.crystallized.push(new e(a))},getForm:function(a){return this.crystallized[a]},getField:function(a,b){return this.getForm(a).crystallizedFields[b]},setFieldConfig:function(a,b,c){if("number"==typeof a)this.getField(a,b).config=f.augment({},this.getField(a,b).defaults,c||{});else if("all"==a)for(var d=0;d<this.crystallized.length;d++)this.crystallized[d].crystallizedFields[b].config=f.augment({},this.crystallized[d].crystallizedFields[b].defaults,c||{});else for(var d=0;d<a.length;d++)this.getField(a[d],b).config=f.augment({},this.getField(a[d],b).defaults,c||{})}},e.prototype={watch:function(a,b){a.addEventListener("submit",function(c){var d=!0;for(var e in this.crystallizedFields)0==this.crystallizedFields[e].config.lastState&&(d=!1);d?b.emit("valid",a):(c.preventDefault(),b.emit("invalid",a))}.bind(this))},removeField:function(a){for(var b=0;b<this.rawFields.length;b++)this.crystallizedFields[a].domOBJ===this.rawFields[b]&&this.rawFields.splice(b,1);delete this.crystallizedFields[a]},addField:function(a){var b;return a.dataset.crystal==c?(console.log('Field element\'s "data-crystal" property must be defined.'),void 0):(b=fieldEl.dataset.crystal,this.rawFields.push(a),this.crystallized[b]=new f(a),void 0)}},f.prototype={wasActive:function(){return this.config.domOBJ==b.activeElement?(this.config.timesActive++,this.config.timesActive):this.config.timesActive},isValid:function(){return this.config.regex.test(this.config.domOBJ.value)?(this.config.domOBJ.className=this.config.domOBJ.className.replace(/(?:^|\s)crystal-invalid(?!\S)/g,""),this.config.lastState=!0,!0):(this.config.domOBJ.className+=" crystal-invalid",this.config.lastState=!1,!1)}},f.augment=g,i.prototype.on=function(a,b){return Array.isArray(this._listeners[a])||(this._listeners[a]=[]),-1===this._listeners[a].indexOf(b)&&this._listeners[a].push(b),this},i.prototype.once=function(a,b){function d(){for(var e=[],f=0;f<arguments.length;f+=1)e[f]=arguments[f];c.off(a,d),b.apply(c,e)}var c=this;return d.listener=b,this.on(a,d)},i.prototype.off=function(a,b){if(!Array.isArray(this._listeners[a]))return this;if("undefined"==typeof b)return this._listeners[a]=[],this;var c=this._listeners[a].indexOf(b);if(-1===c)for(var d=0;d<this._listeners[a].length;d+=1)if(this._listeners[a][d].listener===b){c=d;break}return this._listeners[a].splice(c,1),this},i.prototype.emit=function(a){if(!Array.isArray(this._listeners[a]))return this;for(var b=[],c=1;c<arguments.length;c+=1)b[c-1]=arguments[c];return this._listeners[a].forEach(function(a){a.apply(this,b)},this),this},"object"==typeof module&&module&&"object"==typeof module.exports?module.exports=d:(a.Crystal=d,"function"==typeof define&&define.amd&&define("crystal",[],function(){return d}))}(window,document);